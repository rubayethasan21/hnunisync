<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Example</title>
    <style>
        /* Simple CSS for the modal popup */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 50%;
        }

        .close {
            float: right;
            font-size: 28px;
            cursor: pointer;
        }

        form {
            max-width: 300px;
            margin: 0 auto;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            box-sizing: border-box;
        }

        input[type="submit"] {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
    </style>
    <!-- jQuery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>ILIAS-Kurse mit Matrix-RÃ¤umen synchronisieren</h1>

    <!-- Login Form -->
    <div id="login-view">
        <h2>Mit HHN-Account anmelden</h2>
        <form id="loginForm">
            <label for="username">Benutzername oder E-Mail:</label><br>
            <input type="text" id="username" name="username" required><br>

            <label for="password">Passwort:</label><br>
            <input type="password" id="password" name="password" required><br>

            <input type="submit" value="Anmelden">
        </form>
    </div>


    <div id="otp-view" style="display: none; margin-top: 20px;">
        <h2>Eingabe eines Verifizierungscodes aus der Authenticator-Anwendung.</h2>
        <form id="otpForm">
            <label for="otp">One-time code:</label><br>
            <input type="text" id="otp" name="otp" required><br>
            <input type="submit" value="Anmelden">
        </form>
    </div>


    <!-- The Modal for showing the response -->
    <div id="scrapeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Response:</h2>
            <div id="scrapedData"></div>
        </div>
    </div>

    <div id="user-list" style="display: none;"></div>



    <script>
        $(document).ready(function() {
            const $loginForm = $('#loginForm');
            const $otpForm = $('#otpForm');
            const $modal = $('#scrapeModal');
            const $scrapedDataDiv = $('#scrapedData');
            const $userListDiv = $('#user-list');
            const $loginViewDiv = $('#login-view');
            const $otpViewDiv = $('#otp-view');

            let sessionId;  // Store session ID for OTP submission

            // When the user submits the login form
            $loginForm.on('submit', function(event) {
                event.preventDefault();  // Prevent default form submission

                const loginData = {
                    username: $('#username').val(),
                    password: $('#password').val()
                };

                // Make AJAX request to login endpoint using JSON
                $.ajax({
                    //url: 'http://localhost:8000/login',
                    //url: 'http://hnunisync.de/login',
                    url: '/login',
                    type: 'POST',
                    data: JSON.stringify(loginData),
                    contentType: 'application/json',
                    success: function(data) {
                        if (data.status === 'otp_required') {
                            sessionId = data.session_id;  // Save session ID
                            // Show the OTP form if OTP is required
                            console.log('inside-login-response',sessionId)

                            $loginViewDiv.hide();
                            //$loginForm.hide();
                            //$otpForm.show();
                            $otpViewDiv.show();
                        } else {
                            alert('Login failed');
                        }
                    },
                    error: function(err) {
                        console.error('Error during login:', err);
                        alert('Error during login');
                    }
                });
            });



            // When the user submits the OTP form
            $otpForm.on('submit', function(event) {
                event.preventDefault();  // Prevent default form submission

                let otpData = {
                    otp: $('#otp').val(),
                    session_id: sessionId  // Send session ID with OTP
                };

                console.log(otpData)

                // Make AJAX request to submit OTP endpoint using JSON
                $.ajax({
                    //url: 'http://localhost:8000/submit-otp',
                    //url: 'http://hnunisync.de/submit-otp',
                    url: '/submit-otp',
                    type: 'POST',
                    data: JSON.stringify(otpData),
                    contentType: 'application/json',
                    success: function(data) {
                        // Show the response data in the modal popup
                        $scrapedDataDiv.html(`<p>${data.page_title}</p>`);
                        console.log('all_email_column_data',data.all_email_column_data)
                        $otpForm.hide();
                        $otpViewDiv.hide();

                        // Show the data in the hidden user-list div
                        if (data.all_email_column_data) {
                            $userListDiv.html(JSON.stringify(data.all_email_column_data));
                            $userListDiv.show();  // Unhide the div
                        }

                        $modal.show(); // Show the modal
                    },
                    error: function(err) {
                        console.error('Error during OTP submission:', err);
                        alert('Error during OTP submission');
                    }
                });
            });

            // Close the modal when the user clicks the close button
            $('.close').on('click', function() {
                $modal.hide();
            });

            // Close the modal if the user clicks anywhere outside of the modal
            $(window).on('click', function(event) {
                if ($(event.target).is($modal)) {
                    $modal.hide();
                }
            });
        });
    </script>
</body>
</html>
